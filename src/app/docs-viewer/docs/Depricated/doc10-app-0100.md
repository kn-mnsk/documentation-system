[previous-link]:#docId:index
[next-link]:#docId:doc10-app-0200

[<- previous: index][previous-link] &ensp; &ensp; &ensp; [next: Architecture Diagram ->][next-link]

---
Overview (ID: doc10-app-0100)
=============================
---
Folder Structure(Main Part Only)
--------------------------------

The Docs-Vierwer folder contains the documentation viewer and the Markdown rendering pipeline used throughout the project. It includes the viewer component, the renderer service, enhancement logic, lifecycle coordination, and contributor‑facing documentation.

<div class="align-center10">

```
app/
│  
├── docs-viewer/
│   │
│   ├── docs/ (*1)
│   │   ├── ANGULARREADME.md
│   │   ├── APPREADME/
│   │   │   ├── doc10-app-0100.md (OverView)
│   │   │   ├── doc10-app-0110.md (DocsViewer Key Logic Diagram)
│   │   │   ├── doc10-app-0140.md (Browser Refresh Recovery Diagram)
│   │   │   ├── doc10-app-0200.md (Architecture Diagrasm)
│   │   │   ├── doc10-app-0220.md (DocsViewer API Reference)
│   │   │   ├── doc10-app-0230.md (MarkService API Reference)
│   │   │   ├── doc10-app-0250.md (Session State)
│   │   │   ├── doc10-app-0300.md (Component Dependency)
│   │   │   ├── doc10-app-0400.md (Module Responsibility Map)
│   │   │   ├── doc20-adr-0100.md (Async Rendering Pipeline)
│   │   │   ├── doc30-guide-0100.md (Contributor Guide)
│   │   │   ├── doc30-guide-0200.md (Contributor Onboarding quickstart)
│   │   │   └── doc30-guide-0300.md (Lifecycle Checklist) 
│   │   └── INDEX.md
│   │
│   ├── markdown-enhancers/
│   │   ├── katex.service.ts
│   │   ├── render.service.ts
│   │   ├── mermaid.service.ts
│   │   └── scroll.service.ts
│   │
│   ├── meta/ 
│   │   └── docs-meta.ts
│   │
│   ├── registry/
│   │   └── docs-registry.ts
│   │
│   ├── docs-viewer.directive.ts
│   ├── docs-viewer.html
│   ├── docs-viewer.scss
│   ├── docs-viewer.spec.ts
│   ├── docs-viewer.ts
│   └── session-state.manage.ts
│

...

└── app.ts

```
[(*1) See DocsList in th the docs-meta.ts](#docId:docs-meta)

</div>

Key Features
------------
This is the markdown documentation system, which complies with Katex  and Mermaid renderings. Therefore a user views the most recentlty updated markdown file while editting it, through the browser refersh recovery management.
The system is designed to follow a clear async pipeline that ensures stable layout, correct scroll restoration, and accurate anchor navigation.
    
1. App

>displays main screen(currently blank, though):

>- Adds Render2 listeners - beforeunload and keydown
>- Detects browser refresh  
>- Restores Session State
>- Controls visibility of App and DocsViewer templates
>- Does NOT manage docId or scrollPos

>[ref-1: app.ts](#docId:app)

>[ref-2: Browser Refresh Recovery](#docId:doc10-app-0140)


2. [DocsViewer](#docId:docsviewer)

>displays rendered documentation, manages scroll restoration, anchor navigation. The DocsViewer is created via the [DocsViewerDirective](#docId:viewerdirective):

>- Owns docId and scrollPos, and writes both into sessionState
>- navigates one doc to another
>- loads [Markdown]<a href="https://daringfireball.net/projects/markdown/" target="_blank">Markdown</a>, converts it into html using <a href="https://marked.js.org/" target="_blank">Marked</a>,  renders math typesetting using <a href="https://katex.org/" target="_blank">Katex</a>, renders diagram & chart using  <a href="https://mermaid.js.org/" target="_blank">Mermaid</a>, via MarkService, reacting to docId signal 
>- Restores scrollPos after rendering

>[ref-1: docs-viewer.ts](#docId:docsviewer)

>[ref-2: DocsViewer Key Logic Diagram](#docId:doc10-app-0110)


3. RenderService

>loads Markdown, and convert Markdown to html with custom transforms using __Marked__, and enhances html to render mathh typesetting using __Katex__ and to render diagrams and charts using __Mermaid__.Those modules work together through the following async pipeline, which is the backbone of the entire documentation experience.

>- __Key Public APIs:__

>>1. loadMarkdown():

>>> The main entry point for the DocsViewer.
<div class="align-center10">

```typescript
  loadMarkdown(url: string): Observable<string> {
    return this.http.get(url, { responseType: 'text' });
  }
```
</div>

>>2. renderMarkdown()

>>> After the loadMarkdown(), converts raw Markdown into HTML synchronously, starts async enhancements, and then ends when all enhancements are complete.
<div class="align-center10">

```typescript
async renderMarkdownToDOM(
    markdown: string,
    filetype: string | undefined,
    viewer: HTMLElement,
    isDarkMode: boolean
  ): Promise<void> {

    // 1. Markdown -> html
    const html = this.marked?.parse(markdown) as string;
    viewer.innerHTML = html;
    
    // 2. Sanitize text nodes (replace non-breaking spaces)
    sanitizeNodeText(viewer);
    if (filetype !== "ts") {
      // 3. Katex: Render math expressions
      this.katexService.renderMath(viewer);

      // 4. Apply Mermaid theme
      this.mermaidService.applyMermaidTheme(isDarkMode);

      // 5. Wait for DOM + CSS + fonts + transitions
      await this.waitForViewerToSettle(viewer);;

      // 6. Mermaid: Render diagrams and charts
      await this.mermaidService.renderMermaidBlocks(viewer);
    }

    // 7. Wait again for Mermaid’s own layout changes
    await this.waitForViewerToSettle(viewer);

    // force layout flush
    viewer.getBoundingClientRect();
  }
```
</div>

>- Document(markdown + typrscript) loading (async)
>- Marked to parse and custom-transform Markdown (sync)
>- Katex to render math typesetting (async)
>- Mermaid to render diagrams and (aysnc)
>- HTML injection (sync)
>- Layout-sensitive viewer logic (async after completion)
>- And, this pipeline ensures:

>>- Stable layout
>>- Correct scroll restoration
>>- Accurate anchor navigation

>[ref-1: render.service.ts](#docId:renderservice)


4. Other importnat modules

>- [docs-meta.ts](#docId:docs-meta) - meta infomation for reference to markdown files, etc.
>- [docs-registry.ts](#docsId:docs-registry) - load DocsList in the docs-meta.ts file and provide document title and path
>- [session-state.manager.ts](#docId:session-state) - helpers to manager SessionState with localStorage

<br/>

**In summary:**
1. Rendering is asynchronous
HTML is returned immediately, but enhancements like Mermaid and KaTeX run later.
This means layout is not stable until enhancements complete.

2. Viewer must wait for enhancementComplete$
Scroll restoration and anchor navigation must run only after enhancements finish.

3. Renderer owns enhancement timing
The viewer never runs enhancements directly.

4. Enhancements mutate the DOM
Mermaid injects SVGs, KaTeX replaces nodes, syntax highlighting queues microtasks, and table patching adjusts layout.
    
5. lifecycle this system follows:

>1. App toggles(Ctrl+c) visibility → writes DocsViewer via Directive
>2. DocsViewer updates docId → writes to sessionState
>3. DocsViewer updates scrollPos → writes to sessionState
>4. Before unload → App writes refreshed = true
>5. After refresh → App reads sessionState
>6. If DocsViewer was active → restore doc and sccroll position
>7. If App was active → show App screen

---
[<- previous: index][previous-link] &ensp; &ensp; &ensp; [next: Architecture Diagram ->][next-link]
