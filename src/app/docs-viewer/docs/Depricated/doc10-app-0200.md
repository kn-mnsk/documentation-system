[previous-link]:#docId:doc10-app-0100
[next-link]:#docId:doc10-app-0300
[<- previous: Overview][previous-link] &ensp; &ensp; &ensp; [next: Component Dependency ->][next-link]

---
Architecture Diagram (ID:doc10-app-0200)
========================================
---
<div class="align-center10">
<strong>What This Diagram Shows:</strong>

  1. SSR → Hydration → Browser Init 

  >- SSR renders HTML with no DOM access
  >- Hydration attaches Angular to the existing DOM
  >- App detects browser environment and initializes listeners

  2. App owns refresh detection  [(See Browser Refresh Recovery)](#docId:doc10-app-0140)

  >- Global Listeners Setting

  >>- keydown event - Ctrl+C to toggle App ⇄ DocsViewer
  >>- beforeunload event - sets sessionState.refreshed = true

  >- restoreFromSessionState() decides what to show on reload

  3. DocsViewer owns docId & inlineId + scrollPos [(see DocsViewer Key Logic Diagram)](#docId:doc10-app-0110)

  >- AddEvent Listeners Setting - click event and scroll event
  >- Reactive effect:

  >>- loads raw markdown file, and
  >>- converts markdwon to html using **Marked**, and 
  >>- renders math typesetting using **Katex**, and
  >>- renders diagrams and charts using **Mermaid**
  >- Scroll event update sessionState
  >- click event enables internal navigations among documents, and updates seesionState

  4. ScrollService owns scroll persistence

  >- Saves scrollPos
  >- Restores scroll after markdown render

  5. session-state.manager.ts is the centralized layer

  >- States are:

  >>- component
  >>- docId
  >>- prevDocId
  >>- scrollPos
  >>- refreshed

  6. localStorage is the single source of sessionState

  >- No scattered keys
  >- No hydration surprises
  >- No race conditions

</div>

---

```mermaid
---
title: "Architecture Diagram"
config:
  flowchart:
    curve: bumpY
---
%% curve stye: basis, bumpX, bumpY, cardinal, catmullRom, linear, monotoneX, monotoneY, natural, step, stepAfter, and stepBefore.
flowchart TD 
    %% ============================
    %%  GROUPS
    %% ============================
    
    subgraph SSR["SSR (Server Render)"]
      render_SSR["Render App HTML<br>(no DOM/localStorage)"]
    end

    subgraph HYD["Hydration Engine"]
      attch_HYD["Attach to existing DOM"]
      runInit_HYD["Run component <br>init hooks"]
    end

    subgraph APP["App Component"]
      direction TB
      init_APP["Browser Init<br>(isPlatformBrowser)"]
      listeners_APP["Global Listeners<br>Setting"]
      restore_APP["restoreFromSessionState()"]
    end

    subgraph DVD["DocsViewer Directive"]
      direction TB
      signal_DVD["signal"]
      effect_DVD["effect()"]
      import_DVD["Import DocsViewer"]
      update_DVD["Update DocsViewer"]
    end

    subgraph DV["DocsViewer Component"]
      direction TB
      signal_DV["signal"]
      effect_DV["effect()"]
      subgraph LOAD_DV["loadAndRenderMarkdown()"]
        load_DV["loadMarkdown()"]
        render_DV["renderMarkdownToDOM()"]
        link_DV["Internal Links &<br> OnClick Handling "]
        scroll_DV["OnScroll Handling "]
        restore_DV["Restore Scroll After Rendering"]
      end
    end

    subgraph Enhancers["Markdown Enhancers"]
      direction TB
      Docs-Registry["DocsRegistry Service"]
      subgraph Render_Service["Render Service"]
        load_RS["Load Markdown file"]
        marked_RS["Marked"]
        katex_RS["Katex"]
        mermaid_RS["Mermaid"]
      end 
      subgraph Scroll["ScrollService"]
        get_Scroll["getPosition()"]
        set_Scroll["setPosition()"]
        restore_Scroll["scrollTo<br>ElementInViewer()"]
      end
    end

    %% Document Repository
    Markdown_Repo["Markdown File<br>Repository"]
    

    %% Session State
    subgraph SS_Manager["Session State Manager"]
      direction TB
      read_SS["readSessionState()"]
      write_SS["writeSessionState()"]
      clear_SS["clearSessionState()"]
    end

    %% Listeners
    subgraph App_Listeners["Global Listeners"]
      direction TB
      keydown_App_Listener["keydown event 'Ctrl+C'<br>(isVisible signal<br>false ⇆ true)"]
      beforeunload_App_Listener["beforeunload event<br>'Reload'"]
    end

    subgraph DV_Listeners["AddEvent Listeners"]
      direction TB
      Click_DV_Listener["click event for anchor tag: <br> docId and inlineId"]
      Scroll_DV_Listener["scroll event for Docs Viewer"]
    end

    %%  Local Storage (LS)
    subgraph Local_Storage["localStorage"]
      direction TB
      sessionState_LS["sessionState JSON"]
      %% Includes component, docId, scrollPos, refreshed
    end

    %% ============================
    %%  FLOWS 
    %% ============================

    render_SSR --> attch_HYD
    attch_HYD --> runInit_HYD
    runInit_HYD --> init_APP

    %% App
    init_APP ~~~ restore_APP
    init_APP --> listeners_APP
    read_SS --> init_APP
    restore_APP -->|docId| signal_DVD
    %% restore_APP -->|docId| effect_DVD
    listeners_APP --> keydown_App_Listener
    listeners_APP --> beforeunload_App_Listener
  
    %% SS - Session State
    read_SS ~~~ write_SS ~~~ clear_SS
    Local_Storage --> read_SS
    write_SS --> Local_Storage
    clear_SS --> Local_Storage
    %% restore_APP -->|App active| App-Visible

    %% DVD - DocsViewerDirective
    signal_DVD --> effect_DVD
    effect_DVD --> |DocsViewer new| import_DVD
    effect_DVD --> |DocsViewer active| update_DVD
    import_DVD -->|docId| signal_DV
    update_DVD -->|docId| signal_DV

    %% DV - DocsViewer
    load_DV ~~~ render_DV ~~~ link_DV ~~~ scroll_DV ~~~ restore_DV
    signal_DV --> effect_DV
    effect_DV -->|docId| LOAD_DV
    effect_DV --> write_SS
    effect_DV --> set_Scroll
    render_DV --> Render_Service
    render_DV <--> Docs-Registry
    link_DV --> Click_DV_Listener
    scroll_DV --> Scroll_DV_Listener
    get_Scroll --> restore_DV

    %% Markdown Enhancers
    Docs-Registry ~~~ Render_Service
    load_RS --> marked_RS --> katex_RS --> mermaid_RS
    Render_Service ~~~ Scroll
    Markdown_Repo --> load_RS

    %% Scroll Service
    get_Scroll ~~~ set_Scroll ~~~ restore_Scroll
    scroll_DV --> set_Scroll
    set_Scroll --> write_SS

    %% Listeners
    keydown_App_Listener ~~~ beforeunload_App_Listener
    keydown_App_Listener --> |isVisibleTrue dopcId| signal_DVD
    keydown_App_Listener -->|isVisible=False| init_APP
    beforeunload_App_Listener --> restore_APP

    Click_DV_Listener ~~~ Scroll_DV_Listener
    Click_DV_Listener -->|docId| effect_DV
    Click_DV_Listener -->|inlineId| restore_Scroll

    Scroll_DV_Listener --> set_Scroll
    Scroll_DV_Listener --> write_SS

```
---
[<- previous: Overview][previous-link] &ensp; &ensp; &ensp; [next: ComponentDependency ->][next-link]
